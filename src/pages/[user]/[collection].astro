---
import Layout from '../../layouts/Layout.astro';

const { user, collection } = Astro.params;

// For now, just show a sample collection
const title = `Sample Collection by Demo User`;
---

<Layout 
  title={title} 
  description="A sample collection for testing"
  image="/og-image.png"
  url={Astro.url.href}
  type="website"
>
  <main>
    <header>
      <h1 id="collection-title">Loading...</h1>
      <p id="collection-description">Loading...</p>
      <small id="collection-views">0 views</small>
    </header>
    
    <section class="items" id="collection-items">
      <div class="loading">Loading collection...</div>
    </section>
    
    <!-- Enhanced share buttons -->
    <div class="share-buttons" id="share-buttons" style="display: none;">
      <a href="#" class="share-btn twitter" onclick="shareToTwitter(event)">
        üê¶ Twitter
      </a>
      <a href="#" class="share-btn facebook" onclick="shareToFacebook(event)">
        üìò Facebook
      </a>
      <a href="#" class="share-btn linkedin" onclick="shareToLinkedIn(event)">
        üíº LinkedIn
      </a>
      <button class="share-btn copy" onclick="copyToClipboard()">
        üìã Copy Link
      </button>
    </div>
    
    <!-- Edit button for anonymous collections -->
    <button id="edit-btn" onclick="editCollection()" class="btn-secondary" style="display:none; margin-top: 12px;">
      Edit Collection
    </button>
  </main>
</Layout>

<script>
  import { anonymousSession } from '../../lib/anonymous.js';
  
  let currentCollection = null;
  
  // Load collection data
  async function loadCollection() {
    // Get collection slug from URL path
    const pathParts = window.location.pathname.split('/');
    const collection = pathParts[pathParts.length - 1];
    
    console.log('Collection view - slug from URL:', collection);
    
    // Try to load from anonymous collections first
    const anonCollection = anonymousSession.getCollectionBySlug(collection);
    
    if (anonCollection) {
      // This is an anonymous collection
      currentCollection = anonCollection;
      console.log('Found collection for view:', anonCollection);
      
      // Update page title and meta tags
      document.title = `${anonCollection.title} - TypaVibe`;
      updateMetaTags(anonCollection);
      
      document.getElementById('collection-title').textContent = anonCollection.title;
      document.getElementById('collection-description').textContent = anonCollection.description;
      document.getElementById('collection-views').textContent = `${anonCollection.view_count || 0} views`;
      
      // Show edit button for anonymous collections
      document.getElementById('edit-btn').style.display = 'inline-flex';
      
      // Load items
      const itemsContainer = document.getElementById('collection-items');
      if (anonCollection.items && anonCollection.items.length > 0) {
        itemsContainer.innerHTML = anonCollection.items.map(item => `
          <div class="item">
            <h3><a href="${item.url}" target="_blank">${item.title}</a></h3>
            <p>${item.description}</p>
            ${item.price ? `<span class="price">$${item.price}</span>` : ''}
          </div>
        `).join('');
      } else {
        itemsContainer.innerHTML = `
          <div style="text-align: center; padding: 48px; color: var(--color-text-secondary);">
            <p>No items in this collection yet.</p>
            <button onclick="addItem()" class="btn-primary">Add Your First Item</button>
          </div>
        `;
      }
      
      // Increment view count
      anonymousSession.updateCollection(collection, {
        view_count: (anonCollection.view_count || 0) + 1
      });
      
    } else {
      // Fallback to sample collection
      currentCollection = {
        title: 'Sample Collection',
        description: 'This is a sample collection to test the design and layout.',
        view_count: 42
      };
      
      document.getElementById('collection-title').textContent = 'Sample Collection';
      document.getElementById('collection-description').textContent = 'This is a sample collection to test the design and layout.';
      document.getElementById('collection-views').textContent = '42 views';
      
      document.getElementById('collection-items').innerHTML = `
        <div class="item">
          <h3><a href="#" target="_blank">Sample Item 1</a></h3>
          <p>This is a sample item in the collection.</p>
          <span class="price">$29.99</span>
        </div>
        <div class="item">
          <h3><a href="#" target="_blank">Sample Item 2</a></h3>
          <p>Another sample item for testing.</p>
          <span class="price">$49.99</span>
        </div>
      `;
    }
    
    // Show share buttons
    document.getElementById('share-buttons').style.display = 'flex';
  }
  
  function updateMetaTags(collection) {
    // Update Open Graph meta tags
    const ogTitle = document.querySelector('meta[property="og:title"]');
    const ogDescription = document.querySelector('meta[property="og:description"]');
    const twitterTitle = document.querySelector('meta[property="twitter:title"]');
    const twitterDescription = document.querySelector('meta[property="twitter:description"]');
    
    if (ogTitle) ogTitle.setAttribute('content', collection.title);
    if (ogDescription) ogDescription.setAttribute('content', collection.description);
    if (twitterTitle) twitterTitle.setAttribute('content', collection.title);
    if (twitterDescription) twitterDescription.setAttribute('content', collection.description);
  }
  
  function shareToTwitter(e) {
    e.preventDefault();
    const title = currentCollection?.title || 'Check out this collection';
    const url = window.location.href;
    const text = `${title} on TypaVibe`;
    const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`;
    window.open(twitterUrl, '_blank', 'width=600,height=400');
  }
  
  function shareToFacebook(e) {
    e.preventDefault();
    const url = window.location.href;
    const facebookUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`;
    window.open(facebookUrl, '_blank', 'width=600,height=400');
  }
  
  function shareToLinkedIn(e) {
    e.preventDefault();
    const title = currentCollection?.title || 'Check out this collection';
    const url = window.location.href;
    const linkedinUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(url)}&title=${encodeURIComponent(title)}`;
    window.open(linkedinUrl, '_blank', 'width=600,height=400');
  }
  
  function copyToClipboard() {
    const url = window.location.href;
    navigator.clipboard.writeText(url).then(() => {
      // Show success feedback
      const btn = event.target;
      const originalText = btn.textContent;
      btn.textContent = '‚úÖ Copied!';
      btn.style.background = '#10b981';
      btn.style.color = 'white';
      
      setTimeout(() => {
        btn.textContent = originalText;
        btn.style.background = '';
        btn.style.color = '';
      }, 2000);
    }).catch(() => {
      alert('Failed to copy link. Please copy manually: ' + url);
    });
  }
  
  function editCollection() {
    // Get collection slug from URL path
    const pathParts = window.location.pathname.split('/');
    const collection = pathParts[pathParts.length - 1];
    window.location.href = `/edit/${collection}`;
  }
  
  function addItem() {
    // Get collection slug from URL path
    const pathParts = window.location.pathname.split('/');
    const collection = pathParts[pathParts.length - 1];
    window.location.href = `/edit/${collection}#add-item`;
  }
  
  // Load collection when page loads
  loadCollection();
</script> 