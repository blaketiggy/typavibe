---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="Completing Signup - TypaVibe">
  <main>
    <div class="callback-container">
      <h1>üîê Completing Your Signup</h1>
      <div id="status">Processing...</div>
    </div>
  </main>
</Layout>

<script>
  import { supabase } from '../../lib/supabase.js';
  
  async function handleAuthCallback() {
    const statusDiv = document.getElementById('status');
    
    try {
      // Get the session from the URL
      const { data, error } = await supabase.auth.getSession();
      
      if (error) {
        throw error;
      }
      
      if (!data.session) {
        statusDiv.innerHTML = `
          <div style="color: #dc2626; margin-bottom: 16px;">‚ùå Invalid or expired link</div>
          <button onclick="window.location.href='/auth'" class="btn-primary">Try Again</button>
        `;
        return;
      }
      
      const user = data.session.user;
      const username = user.user_metadata?.username;
      
      console.log('Auth callback - User:', user);
      console.log('Auth callback - User metadata:', user.user_metadata);
      console.log('Auth callback - Username from metadata:', username);
      
      if (username) {
        // This is a new user with a username - create their profile
        statusDiv.innerHTML = '<div style="color: #f59e0b;">üîÑ Setting up your profile...</div>';
        
        console.log('Creating profile for new user with username:', username);
        
        const { error: profileError } = await supabase
          .from('profiles')
          .insert({
            id: user.id,
            username: username,
            display_name: username,
            email: user.email,
            created_at: new Date().toISOString()
          });
        
        if (profileError) {
          console.error('Profile creation error:', profileError);
          // Profile might already exist, continue anyway
        } else {
          console.log('Profile created successfully for username:', username);
        }
        
        statusDiv.innerHTML = `
          <div style="color: #10b981; margin-bottom: 16px;">‚úÖ Account created successfully!</div>
          <p style="color: var(--color-text-secondary); margin-bottom: 24px;">
            Welcome to TypaVibe, @${username}!
          </p>
          <button onclick="window.location.href='/dashboard'" class="btn-primary">
            Go to Dashboard
          </button>
        `;
        
      } else {
        // This is an existing user signing in
        // Check if they have a profile, create one if they don't
        console.log('Existing user signing in, checking for profile...');
        
        try {
          const { data: existingProfile, error: profileCheckError } = await supabase
            .from('profiles')
            .select('id')
            .eq('id', user.id)
            .single();
          
          console.log('Profile check result:', { existingProfile, profileCheckError });
          
          if (!existingProfile && !profileCheckError) {
            // No profile exists, create one with a default username
            console.log('Creating profile for existing user...');
            const fallbackUsername = `user_${user.id.substring(0, 8)}`;
            
            const { error: profileCreateError } = await supabase
              .from('profiles')
              .insert({
                id: user.id,
                username: fallbackUsername,
                display_name: `User ${user.id.substring(0, 8)}`,
                email: user.email,
                created_at: new Date().toISOString()
              });
            
            if (profileCreateError) {
              console.error('Error creating profile for existing user:', profileCreateError);
            } else {
              console.log('Profile created successfully for existing user:', fallbackUsername);
            }
          }
        } catch (profileError) {
          console.error('Profile check error for existing user:', profileError);
        }
        
        statusDiv.innerHTML = `
          <div style="color: #10b981; margin-bottom: 16px;">‚úÖ Signed in successfully!</div>
          <button onclick="window.location.href='/dashboard'" class="btn-primary">
            Go to Dashboard
          </button>
        `;
      }
      
    } catch (error) {
      console.error('Auth callback error:', error);
      statusDiv.innerHTML = `
        <div style="color: #dc2626; margin-bottom: 16px;">‚ùå Error completing signup</div>
        <p style="color: var(--color-text-secondary); margin-bottom: 24px;">
          ${error.message}
        </p>
        <button onclick="window.location.href='/auth'" class="btn-primary">
          Try Again
        </button>
      `;
    }
  }
  
  // Handle the callback when page loads
  handleAuthCallback();
</script>

<style>
  .callback-container {
    max-width: 480px;
    margin: 0 auto;
    text-align: center;
    padding: 48px 24px;
  }
  
  .callback-container h1 {
    margin-bottom: 32px;
  }
  
  #status {
    background: var(--color-background-secondary);
    border: 1.5px solid var(--color-border);
    border-radius: var(--radius);
    padding: 32px;
    margin-bottom: 24px;
  }
</style> 