---
import Layout from '../../layouts/Layout.astro';

const { collection } = Astro.params;
---

<Layout title="Edit Collection - TypaVibe">
  <main>
    <header>
      <h1 id="edit-title">Edit Collection</h1>
    </header>
    
    <!-- Simple collection details -->
    <div style="margin-bottom: 32px;">
      <h2 id="collection-title">Loading...</h2>
      <p id="collection-description" style="color: var(--color-text-secondary);">Loading...</p>
    </div>
    
    <!-- Step-by-step add item section -->
    <section class="add-item-section">
      <h2>Add Items</h2>
      
      <!-- Add Item Button -->
      <button id="add-item-btn" class="btn-primary">
        âž• Add Item
      </button>
      
      <!-- Step-by-step form (hidden initially) -->
      <div id="add-item-form" class="step-form" style="display: none;">
        <div class="step" id="step-url">
          <label>Product URL</label>
          <input 
            id="item-url" 
            placeholder="Paste product URL here..." 
            type="url" 
            required 
          />
          <div class="step-buttons">
            <button type="button" class="btn-secondary" onclick="cancelAddItem()">Cancel</button>
            <button type="button" class="btn-primary" onclick="nextStep('title')">Next</button>
          </div>
        </div>
        
        <div class="step" id="step-title" style="display: none;">
          <label>Item Title (optional)</label>
          <input 
            id="item-title" 
            placeholder="Leave blank to use website title" 
          />
          <div class="step-buttons">
            <button type="button" class="btn-secondary" onclick="prevStep('url')">Back</button>
            <button type="button" class="btn-primary" onclick="nextStep('notes')">Next</button>
          </div>
        </div>
        
        <div class="step" id="step-notes" style="display: none;">
          <label>Notes (optional)</label>
          <textarea 
            id="item-notes" 
            placeholder="Add any notes about this item..."
            rows="3"
          ></textarea>
          <div class="step-buttons">
            <button type="button" class="btn-secondary" onclick="prevStep('title')">Back</button>
            <button type="button" class="btn-primary" onclick="nextStep('price')">Next</button>
          </div>
        </div>
        
        <div class="step" id="step-price" style="display: none;">
          <label>Price (optional)</label>
          <input 
            id="item-price" 
            placeholder="e.g., $29.99" 
            type="text"
          />
          <div class="step-buttons">
            <button type="button" class="btn-secondary" onclick="prevStep('notes')">Back</button>
            <button type="button" class="btn-primary" onclick="addItem()">Add Item</button>
          </div>
        </div>
      </div>
    </section>
    
    <!-- Items list appears here -->
    <div id="items-list" style="margin-top: 32px;">
      <p style="text-align: center; color: var(--color-text-secondary);">No items yet. Add your first item above!</p>
    </div>
    
    <div style="margin-top: 48px; text-align: center;">
      <button id="publish-btn" class="btn-primary">
        ðŸš€ Publish & Share
      </button>
      <button onclick="window.location.href='/'" class="btn-secondary" style="margin-left: 12px;">
        Back to Home
      </button>
    </div>
  </main>
</Layout>

<script>
  import { anonymousSession } from '../../lib/anonymous.js';
  
  let currentCollection = null;
  let currentStep = 'url';
  
  // Load collection data
  function loadCollection() {
    // Get collection slug from URL path
    const pathParts = window.location.pathname.split('/');
    const collection = pathParts[pathParts.length - 1];
    
    console.log('Collection slug from URL:', collection);
    console.log('All path parts:', pathParts);
    
    const anonCollection = anonymousSession.getCollectionBySlug(collection);
    console.log('Anonymous session result:', anonCollection);
    
    if (anonCollection) {
      currentCollection = anonCollection;
      console.log('Found collection:', anonCollection);
      
      // Show collection details
      document.getElementById('collection-title').textContent = anonCollection.title;
      document.getElementById('collection-description').textContent = anonCollection.description;
      document.getElementById('edit-title').textContent = `Edit: ${anonCollection.title}`;
      
      // Load existing items
      loadItems();
    } else {
      console.log('Collection not found for slug:', collection);
      console.log('Available collections:', anonymousSession.getAnonymousCollections());
      alert('Collection not found!');
      window.location.href = '/';
    }
  }
  
  function loadItems() {
    console.log('loadItems called');
    const itemsContainer = document.getElementById('items-list');
    console.log('Items container:', itemsContainer);
    console.log('Current collection:', currentCollection);
    
    if (currentCollection.items && currentCollection.items.length > 0) {
      console.log('Items found:', currentCollection.items);
      itemsContainer.innerHTML = currentCollection.items.map((item, index) => `
        <div class="item-display">
          <div class="item-content">
            <h3><a href="${item.url}" target="_blank">${item.title}</a></h3>
            ${item.description ? `<p class="item-description">${item.description}</p>` : ''}
            ${item.price ? `<span class="item-price">${item.price}</span>` : ''}
          </div>
          <button onclick="deleteItem(${index})" class="btn-secondary delete-btn">
            Delete
          </button>
        </div>
      `).join('');
    } else {
      console.log('No items found');
      itemsContainer.innerHTML = '<p style="text-align: center; color: var(--color-text-secondary);">No items yet. Add your first item above!</p>';
    }
  }
  
  function deleteItem(index) {
    if (confirm('Delete this item?')) {
      currentCollection.items.splice(index, 1);
      anonymousSession.updateCollection(currentCollection.slug, {
        items: currentCollection.items
      });
      loadItems();
    }
  }
  
  function publishCollection() {
    // Get collection slug from URL path
    const pathParts = window.location.pathname.split('/');
    const collection = pathParts[pathParts.length - 1];
    window.location.href = `/demo/${collection}`;
  }
  
  // Add item flow functions
  function showAddItemForm() {
    document.getElementById('add-item-btn').style.display = 'none';
    document.getElementById('add-item-form').style.display = 'block';
    document.getElementById('item-url').focus();
  }
  
  function cancelAddItem() {
    document.getElementById('add-item-btn').style.display = 'inline-flex';
    document.getElementById('add-item-form').style.display = 'none';
    document.getElementById('add-item-form').reset();
    currentStep = 'url';
    showStep('url');
  }
  
  function nextStep(step) {
    if (currentStep === 'url') {
      const url = document.getElementById('item-url').value;
      if (!url.trim()) {
        alert('Please enter a URL');
        return;
      }
    }
    
    currentStep = step;
    showStep(step);
  }
  
  function prevStep(step) {
    currentStep = step;
    showStep(step);
  }
  
  function showStep(step) {
    // Hide all steps
    document.querySelectorAll('.step').forEach(s => s.style.display = 'none');
    // Show current step
    document.getElementById(`step-${step}`).style.display = 'block';
  }
  
  function addItem() {
    const url = document.getElementById('item-url').value;
    const title = document.getElementById('item-title').value || 'Product from link';
    const description = document.getElementById('item-notes').value;
    const price = document.getElementById('item-price').value;
    
    const newItem = {
      url: url,
      title: title,
      description: description,
      price: price
    };
    
    if (!currentCollection.items) {
      currentCollection.items = [];
    }
    
    currentCollection.items.push(newItem);
    
    anonymousSession.updateCollection(currentCollection.slug, {
      items: currentCollection.items
    });
    
    // Reset form and hide
    cancelAddItem();
    loadItems();
  }
  
  // Make functions globally accessible
  window.nextStep = nextStep;
  window.prevStep = prevStep;
  window.cancelAddItem = cancelAddItem;
  window.addItem = addItem;
  window.deleteItem = deleteItem;
  window.publishCollection = publishCollection;
  
  // Event listeners
  document.getElementById('add-item-btn').addEventListener('click', showAddItemForm);
  document.getElementById('publish-btn').addEventListener('click', publishCollection);
  
  // Load collection when page loads
  loadCollection();
</script>

<style>
  .add-item-section {
    background: var(--color-background-secondary);
    border: 1.5px solid var(--color-border);
    border-radius: var(--radius);
    padding: 24px;
    margin-bottom: 24px;
  }
  
  .add-item-section h2 {
    margin-bottom: 16px;
  }
  
  .step-form {
    margin-top: 16px;
  }
  
  .step {
    margin-bottom: 16px;
  }
  
  .step label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: var(--color-text);
  }
  
  .step input,
  .step textarea {
    width: 100%;
    margin-bottom: 12px;
  }
  
  .step-buttons {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
  }
  
  .item-display {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    background: var(--color-background-secondary);
    border: 1.5px solid var(--color-border);
    border-radius: var(--radius-sm);
    padding: 16px;
    margin-bottom: 12px;
  }
  
  .item-content {
    flex: 1;
    margin-right: 12px;
  }
  
  .item-content h3 {
    margin: 0 0 4px 0;
  }
  
  .item-content h3 a {
    color: var(--color-accent);
    text-decoration: none;
    font-weight: 600;
  }
  
  .item-content h3 a:hover {
    text-decoration: underline;
  }
  
  .item-description {
    color: var(--color-text-secondary);
    font-size: 14px;
    margin: 0 0 4px 0;
    line-height: 1.4;
  }
  
  .item-price {
    color: var(--color-accent);
    font-weight: 600;
    font-size: 14px;
  }
  
  .delete-btn {
    padding: 8px 16px;
    font-size: 13px;
    min-height: auto;
    flex-shrink: 0;
  }
</style> 